# 更新履歷

## [1.6.4] - 2025-12-08

### ✨ 新增功能
- **聊天室顯示好感度與關係等級**
  - 私聊：在 Header 右側按鈕下方顯示目前好感度數值和關係等級標籤
  - 群聊：成員列表中每位成員的「記憶」按鈕下方顯示好感度和關係
  - 樣式與好友列表頁面一致，關係等級標籤有對應顏色背景
  - 支援響應式設計，手機版自動縮小字體和間距

- **角色間關係狀態管理**
  - 角色詳情頁可查看 LLM 評估的關係狀態
  - 可手動清除不需要的關係狀態描述

### 🔧 技術改進
- 狀態訊息生成改用 System Prompt 架構
  - 將角色設定（個性、說話風格、背景）放入 `systemInstruction`
  - 任務指令放入 User Prompt，職責分離更清晰

---

## [1.6.3] - 2025-12-08

### 🐛 Bug 修正
- **修正記憶系統空回應未正確處理的問題**
  - 當 Gemini API 因安全機制封鎖內容時，記憶系統會收到空字串回應
  - 原本空回應會被當作成功處理，導致 tracking 記錄被錯誤更新
  - 現在 `generateMemorySummary`、`extractLongTermMemories` 會檢查空回應並正確拋出錯誤
  - 記憶/情境生成失敗時不再更新處理記錄，下次對話仍會重試

- **改善 `evaluateCharacterRelationships` 空回應處理**
  - 關係評估遇到空回應時會印出警告 log，並返回空陣列
  - 不影響主流程，但提供更清楚的錯誤診斷資訊

### 🔧 技術改進
- 記憶服務 API 呼叫後會檢查 `promptFeedback.blockReason` 和 `finishReason`
- 區分「真正的空回應」和「被安全機制封鎖」的情況

---

## [1.6.2] - 2025-12-07

### ✨ 新增功能
- **聊天室草稿自動保存**
  - 離開聊天室時自動保存輸入框中未發送的訊息
  - 返回聊天室時自動載入先前的草稿內容
  - 訊息發送後自動清除草稿
  - 草稿資料持久化到 LocalStorage，關閉瀏覽器也不會遺失

### 🐛 Bug 修正
- **修正群聊洗牌導致 AI 重複輸出的問題**
  - 群聊中每一輪回應順序會隨機洗牌，但若本輪首發者與前一輪最後發言人相同，AI 容易詞窮而重複輸出
  - 新增 `shuffleAvoidFirst` 函數，洗牌後自動將與前一輪最後發言人相同的角色移到陣列末尾
  - 確保每輪首發者不會與前一輪最後發言人重複，讓對話更自然流暢

---

## [1.6.1] - 2025-12-05

### ✨ UI/UX 改進
- **性別選項卡片化設計**
  - 性別選擇改為卡片式 radio button，提供更大的點擊區域
  - 選中時顯示主色調邊框和淡背景色，視覺回饋更明顯
  - Hover 效果讓互動更直覺
  - 三個選項等寬分布，整體更美觀

### 🐛 Bug 修正
- **修正機密版名片標記顯示問題**
  - 修正匯出時勾選「隱藏詳細設定」後，名片上「-機密-」標記未正確顯示的問題
  - `createCharacterCardImage` 函數現在正確接收 `hidePrivateSettings` 參數

## [1.6.0] - 2025-12-05

### ✨ 新增功能
- **負數好感度系統**
  - 新增「仇敵」(-100 以下) 和「不爽」(-100 ~ -30) 兩個負面關係等級
  - 陌生人等級範圍調整為 -30 ~ 10，包含淡淡的不滿
  - 好感度調整介面支援 -300 ~ 300 範圍

- **聊天室智慧排序**
  - 聊天室列表依最後訊息時間排序，最新的在最上面
  - 方便快速找到最近的對話

- **頭像快速導航**
  - 點擊聊天室中任何角色的頭像，可直接跳轉到該角色的詳細頁面
  - 滑鼠懸停時有視覺回饋（縮放效果）

- **批次記憶新增功能**
  - 新增 `addCharacterMemories` 方法，支援批次新增長期記憶
  - 批次新增時只觸發一次狀態訊息生成，提升效能

### 🐛 Bug 修正
- **修正長期記憶批次生成時重複觸發狀態更新**
  - 原本一次生成 N 筆長期記憶會觸發 N 次狀態訊息生成
  - 改為批次新增後只觸發一次，避免浪費 API 額度


- **修正 AI 回應換行消失問題**
  - 修正 `deduplicateMentions` 函數錯誤清理空白字元，導致 `\n` 被移除
  - 修正 `gemini.ts` 中移除角色名前綴時誤刪換行符號
  - AI 回應的換行格式現在能正確保留和顯示

- **@ 提及去重優化**
  - 同一則訊息內，相同的 @ID 只保留第一個出現的位置
  - 支援數字 ID 和 UUID 格式
  - 避免 AI 過度謹慎重複 @ 同一個角色

- **內容封鎖智慧重試機制**
  - 當 Gemini API 誤判內容違規時，自動進行三層降級重試：
    1. 完整對話歷史（20 則訊息）
    2. 縮短歷史（5 則訊息）
    3. 無歷史模式
  - 確保對話歷史第一則訊息必定是使用者訊息，避免 API 錯誤
  - 不會丟失使用者輸入的訊息

- **空回應自動處理**
  - AI 回應為空字串時自動重試一次
  - 第二次仍為空則顯示「*沉默不語*」，保持對話流暢

- **好感度解析精準化**
  - 修正列表編號（如「1.」）被誤判為好感度變化的問題
  - 只有當最後一行為純數字（允許負號）時才視為好感度

### 🔧 技術改進
- 優化正則表達式處理，減少對換行符號的誤操作
- 改善錯誤處理邏輯，提升系統穩定性

---

## [1.5.0] - 2025-12-05

### ✨ 新增功能
- **好友狀態訊息系統**
  - 每位好友都可以設定狀態訊息（類似 LINE 的個人狀態）
  - 支援手動編輯或 AI 自動生成狀態訊息
  - 三種自動觸發時機：
    - 好友上線時（離線/忙碌中 → 在線）
    - 與你的關係等級提升時（例如：陌生人 → 朋友）
    - 生成長期記憶時（代表發生重大事件）
  - AI 生成會參考：角色性格、短期記憶、當前時間

- **全域 Toast 通知系統**
  - 取代舊有的 alert / 系統訊息機制
  - 好友上線時會顯示可點擊的通知（需達到「朋友」等級以上）
  - 點擊通知可快速跳轉到該好友的聊天室
  - 群聊中好友無法回應時，改用 Toast 提示（不再產生系統訊息）

- **作息監控系統優化**
  - 改為「應用載入時 + 每整點」檢查作息狀態
  - 降低檢查頻率，提升效能（從每分鐘 1 次改為每小時 1-2 次）
  - 配合作息表精度（小時級別）

- **好友詳細頁面增強**
  - 頭像旁顯示即時狀態指示燈（綠色/黃色/紅色）
  - 新增「作息表」區塊，清楚呈現好友的在線時段

### 🎨 UI/UX 改進
- 好友列表和聊天室的狀態文字顏色會隨狀態改變
- Toast 通知支援不同類型（成功/錯誤/警告/資訊）
- 好友上線通知包含頭像，更直覺
- 聊天室成員列表也會顯示狀態顏色

### 🔧 技術改進
- 使用動態 import 避免 Store 之間的循環依賴
- Toast 系統採用 Composable 模式，全域共用狀態
- 狀態訊息自動持久化到 LocalStorage

---

## [1.4.4] - 2025-12-05

### ✨ 新增功能
- **聊天室管理增強**
  - 新增「刪除整個聊天室」功能（包含所有訊息和情境記憶）
  - 新增「新增成員到現有群組」功能，可隨時擴充群組成員
  - 自動檢查群組人數上限（15 人）

### 🔧 技術改進
- **Z-index 階層統一管理**
  - 在全域樣式中定義統一的 z-index 變數系統
  - 解決 Panel 和 Modal 的層級衝突問題
  - 新增 `panel-overlay` 全域樣式類別

---

## [1.4.3] - 2025-12-04

### 🔧 技術改進
- 群聊順序不再固定，隨機輪流更真實

### 🎨 UI/UX 改進
- 調整聊天室的介面，讓手機版本比較不壅擠

---

## [1.4.2] - 2025-12-04

### ✨ 新增功能
- **群聊系統通知**
  - 當好友因忙碌或離線無法回覆時，會顯示系統提示訊息
  - 使用者不再誤以為是 bug，能清楚了解好友的狀態

### 🔧 技術改進
- **名片匯入容錯性提升**
  - 放寬驗證條件：只要有角色名稱和性格描述即可匯入
  - 其他欄位（如說話風格、年齡等）允許留空
  - 提升向後相容性，支援匯入不完整或舊版本的名片
- **Debug 機制優化**
  - 新增 PNG 隱寫術的詳細 debug 訊息
  - 新增名片匯入的診斷訊息
  - 方便開發時快速定位問題

---

## [1.4.1] - 2025-12-04

### 🎨 UI/UX 改進
- **聊天室好友狀態文字顏色**
  - 現在不同狀態的文字顏色會不一樣了

---

## [1.4.0] - 2025-12-04

### ✨ 新增功能
- **好友名片系統**
  - 支援匯出好友為精美的 PNG 名片
  - 名片包含好友資訊與稀有度 Badge（R、SR、SSR、UR）
  - 稀有度根據好感度決定機率（好感度越高，抽到高稀有度機率越高）
  - PNG 隱寫術技術：名片內嵌完整好友資料（tEXt chunk）
  - 支援從 PNG 名片匯入好友，保留所有設定
  - 匯出資料包含：基本資料、性格、說話風格、背景、喜好、作息時間、系統提示詞等
  - 匯出時自動排除好感度和記憶（避免隱私外洩）

- **名片作者署名系統**
  - 記錄好友的原始創作者（首次匯出者）
  - 追蹤所有經手人（貢獻者列表）
  - 名片底部顯示「推薦人」資訊
  - 匯入名片時保留完整的作者與貢獻者資訊
  - 好友詳情頁顯示「認識的人類朋友」：原始創作者和所有經手人

- **匯入介面優化**
  - 空狀態時提供「新增好友」和「匯入名片」雙選項
  - FAB 浮動按鈕整合匯入功能
  - 使用 lucide-vue-next 圖示美化介面

### 🎨 UI/UX 改進
- **統一用詞調整**
  - 將「角色」改稱為「好友」，提升代入感
  - 將「角色卡」改稱為「名片」，更貼近社交情境
  - 調整所有前端顯示文字，保持一致性

- **名片設計優化**
  - Badge 採用白底彩色字 + 彩色邊框設計
  - 標籤分兩列顯示：第一列「性別 + 年齡」，第二列「職業」
  - 避免職業名稱過長時文字溢出畫面
  - 底部顯示推薦人資訊，使用品牌副標題樣式
  - 增強稀有度視覺辨識度
  - 整體設計風格與應用程式 Header 一致

### 🔧 技術改進
- 實作 PNG tEXt chunk 讀寫功能
- 實作 CRC32 校驗確保資料完整性
- Canvas API 繪製名片圖像
- 支援完整的好友資料序列化/反序列化
- 版本號自動同步機制：build 時從 CHANGELOG.md 讀取最新版本並更新到 version.json
- 保留角色創建日期（createdAt）在匯出/匯入流程中

---

## [1.3.3] - 2025-12-04

### 🔧 技術改進
- 優化清除快取的功能

---

## [1.3.2] - 2025-12-03

### 🎨 UI/UX 改進
- 支援粗體的 Markdown 語法（**粗體**）
- 新增ICON
- 事件輸入框支援斷行，並增加自數上限
- UI介面調整

---

## [1.3.1] - 2025-12-03

### 🐛 問題修復
- **群聊訊息歷史限制問題**
  - 修復群聊滿 20 句時 Gemini API 報錯問題
  - 確保對話歷史第一條訊息必須是使用者訊息
  - 自動調整歷史記錄格式符合 API 要求

- **背景執行機制**
  - 修復切換聊天室時訊息寫入錯誤問題
  - 訊息現在會正確寫入原聊天室，而非當前顯示的聊天室
  - 支援在背景繼續完成角色回應
  - 保存聊天室和角色資訊，避免 computed 值失效

- **記憶處理觸發機制**
  - 修復群聊記憶和情境摘要不會自動生成的問題
  - 改進觸發條件，避免訊息數量跳過門檻值
  - 新增追蹤機制，記錄每個聊天室的處理狀態
  - 追蹤資料持久化到 localStorage，重新整理不會遺失

### 🔧 技術改進
- 優化對話歷史處理邏輯
- 加強錯誤處理和 console 日誌
- 改善聊天室切換時的資料一致性

---

## [1.3.0] - 2025-12-03

### ✨ 新增功能
- **群組聊天系統**
  - 支援多角色群組對話（最多 15 位角色）
  - @提及功能（@角色名 或 @all）
  - 輸入 @ 時顯示角色選單，可快速選擇角色
  - 群組成員管理介面
  - 群組聊天室自動生成情境摘要（每 30 則訊息）
  - 查看群組成員記憶功能

- **角色作息系統**
  - 設定角色活躍時段（每週時間表）
  - 預設模板：全天在線、上班族、學生、夜貓子
  - 自訂作息時段
  - 非活躍時段角色不會出現在群組聊天內
  - 新角色預設使用「上班族」作息

- **記憶系統架構重構**
  - 記憶系統改為角色綁定（非聊天室綁定）
  - 短期記憶可在記憶管理頁面編輯和刪除
  - 私聊每 15 則訊息自動生成短期記憶
  - 群聊每 30 則訊息自動生成情境摘要
  - 舊版本資料自動遷移

- **版本管理系統優化**
  - 版本號從伺服器動態讀取
  - 更新履歷從 CHANGELOG.md 解析
  - 每次路由切換時檢查版本更新
  - 單一檔案維護版本歷史

### 🎨 UI/UX 改進
- 動作描述改用 Markdown 語法（*動作*）
- @ 提及選單顯示角色大頭貼
- 群組成員面板顯示角色資訊
- 改善記憶管理介面（短期/長期記憶分開顯示）

### 🐛 問題修復
- 修復關係初始化問題，確保好感度正常增加
- 修復短期記憶顯示錯誤
- 清理未使用的程式碼

### 🔧 重構
- 記憶系統從 room-bound 改為 character-bound
- 提取作息判斷邏輯為共用函數
- 統一版本資訊來源

---

## [1.2.0] - 2025-12-02

### ✨ 新增功能
- **API Key 管理優化**
  - 新增 API Key 檢測功能（使用 countTokens 方法，不消耗額度）
  - 新增顯示/隱藏密碼功能（眼睛圖示切換）
  - 改善 API Key 輸入欄位 UI（input group 設計）
  - 新增 Google AI Studio 連結，方便查看額度

- **記憶管理改進**
  - 優化聊天室長期記憶顯示，改為唯讀模式
  - 新增提示引導至記憶管理頁進行編輯
  - 聊天室與記憶管理頁職責分工更明確

### 🐛 問題修復
- 修復 iOS 18.1.1 長按複製/刪除訊息功能
  - 新增觸控事件支援（touchstart, touchend, touchmove）
  - 加入震動回饋提示

### 📝 文件更新
- 改善系統提示詞說明文字
- 列出自動生成內容項目，避免使用者重複設定

---

## [1.1.0] - 2025-12-01

### ✨ 新增功能
- **記憶管理面板**
  - 可查看角色的所有長期記憶
  - 可新增、編輯、刪除記憶
  - 顯示記憶來源（手動/自動）和建立時間

- **手動生成記憶**
  - 可在聊天室即時將對話轉換為記憶
  - 支援長期和短期記憶生成

- **匯出/匯入優化**
  - 匯出功能現在包含聊天訊息
  - 完整備份所有資料

### 🎨 UI 改進
- 改善底部導航列圖示顯示效果
- 使用動態 fill 屬性切換圖示狀態

### 🔧 程式碼重構
- 提取重複的條件判斷為 helper 函數
- 提升程式碼可維護性

---

## [1.0.0] - 2025-12-02

### ✨ 新增功能
- **角色管理系統**
  - 建立和編輯 AI 角色（最多 15 個）
  - 自訂角色外觀、性格、說話風格
  - 設定角色背景故事和重要事件

- **聊天功能**
  - 單人聊天室
  - 訊息歷史紀錄

- **記憶系統**
  - 長期記憶（角色全域記憶，最多 10 筆）
  - 短期記憶（情境記憶，最多 6 筆）
  - 自動記憶摘要生成
  - 智慧記憶升級機制

- **關係系統**
  - 好感度系統（0-200+）
  - 五個關係等級（陌生人、點頭之交、朋友、好友/曖昧、摯友/戀人）
  - 戀愛/友情路線切換
  - AI 自動評估好感度變化

- **使用者設定**
  - 個人資料設定
  - Gemini API Key 設定
  - 資料匯出/匯入功能
  - 清除所有資料功能

- **Google Drive 雲端同步**
  - OAuth 2.0 授權登入
  - 自動備份到 Google Drive
  - 從雲端還原資料
  - 連線狀態顯示

### 🎨 介面設計
- 響應式設計，支援桌面和行動裝置
- 直覺的操作介面

### 🔧 技術特色
- Vue 3 + TypeScript
- Pinia 狀態管理
- Gemini 2.5 Flash AI 模型
- 本地資料儲存（LocalStorage）
- Google Drive API 整合
- GitHub Pages 部署

---

## 未來計劃

### 🚀 計劃功能
- [ ] 更多關係互動選項
- [ ] 自訂主題顏色
- [ ] NPC關係進展評估系統
- [ ] 好友狀態列
- [ ] 好友動態牆